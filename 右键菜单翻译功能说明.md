# 右键菜单翻译功能说明

## 功能概述

新增的右键菜单翻译功能允许用户通过右键菜单来控制翻译功能的开启和关闭，提供了更灵活的用户体验。

## 文件结构

- `context-menu-translator.js` - 右键菜单翻译功能的主要实现文件
- `test-context-menu.html` - 测试页面，用于验证功能
- `manifest.json` - 已更新，包含新的content script

## 主要功能

### 1. 右键菜单
- 在页面任意位置右键点击，会弹出翻译控制菜单
- 菜单包含以下选项：
  - **开启翻译** - 激活翻译功能
  - **关闭翻译** - 停用翻译功能
  - **翻译状态** - 显示当前翻译状态
  - **关于翻译工具** - 显示工具信息

### 2. 翻译控制
- **开启翻译**: 绑定翻译事件，激活鼠标悬浮翻译功能
- **关闭翻译**: 解绑翻译事件，停用翻译功能
- **状态管理**: 自动保存和恢复翻译状态

### 3. 状态持久化
- 翻译状态保存在本地存储中
- 页面刷新后自动恢复之前的翻译状态
- 支持不同页面的独立状态管理

## 技术实现

### 核心类: ContextMenuTranslator

```javascript
class ContextMenuTranslator {
  constructor() {
    this.isTranslationEnabled = false;
    this.translationTooltip = null;
    this.contextMenu = null;
    this.menuItems = [];
  }
}
```

### 主要方法

1. **init()** - 初始化右键菜单功能
2. **createContextMenu()** - 创建右键菜单UI
3. **enableTranslation()** - 开启翻译功能
4. **disableTranslation()** - 关闭翻译功能
5. **bindTranslationEvents()** - 绑定翻译事件
6. **unbindTranslationEvents()** - 解绑翻译事件

### 事件绑定复用

新功能复用了 `content.js` 中的 `TranslationTooltip` 类：
- 复用 `bindEvents()` 方法绑定翻译事件
- 复用 `handleMouseOver` 和 `handleMouseOut` 事件处理
- 复用 `showTooltip` 和 `hideTooltip` 显示逻辑

## 使用方法

### 1. 基本使用
1. 在页面任意位置右键点击
2. 选择"开启翻译"
3. 鼠标悬浮在文本上查看翻译
4. 右键选择"关闭翻译"停用功能

### 2. 状态查看
- 右键菜单中的"翻译状态"会显示当前状态
- 开启状态显示绿色"已开启"
- 关闭状态显示红色"已关闭"

### 3. 信息查看
- 右键菜单中的"关于翻译工具"显示详细信息
- 包括版本、功能描述、当前状态、字典条目数等

## 配置说明

### manifest.json 更新
```json
{
  "content_scripts": [
    {
      "matches": ["<all_urls>"],
      "js": [
        "shared-dom-observer.js",
        "translation-service.js", 
        "text-segment-translator.js",
        "display-formatter.js",
        "iframe-cache-manager.js",
        "iframe-handler.js",
        "lightweight-popup-detector.js",
        "content.js",
        "context-menu-translator.js"
      ],
      "css": ["styles.css"],
      "run_at": "document_end"
    }
  ]
}
```

### 加载顺序
- `context-menu-translator.js` 必须在 `content.js` 之后加载
- 这样可以确保 `TranslationTooltip` 类已经定义

## 测试方法

### 1. 使用测试页面
打开 `test-context-menu.html` 进行功能测试：
- 包含多种测试元素（按钮、文本、表单等）
- 提供详细的使用说明
- 可以验证各种翻译场景

### 2. 测试步骤
1. 右键点击页面任意位置
2. 选择"开启翻译"
3. 鼠标悬浮在测试文本上
4. 验证翻译功能是否正常
5. 右键选择"关闭翻译"
6. 验证翻译功能是否已停用

## 注意事项

### 1. 兼容性
- 与现有的 `content.js` 完全兼容
- 不会影响原有的自动翻译功能
- 可以独立使用或与原有功能配合使用

### 2. 性能考虑
- 右键菜单只在需要时创建
- 事件绑定/解绑采用高效的方式
- 状态保存使用轻量级的本地存储

### 3. 错误处理
- 包含完整的错误处理机制
- 提供用户友好的错误提示
- 支持降级处理

## 扩展功能

### 1. 快捷键支持
可以添加键盘快捷键来快速开启/关闭翻译：
```javascript
document.addEventListener('keydown', (e) => {
  if (e.ctrlKey && e.shiftKey && e.key === 'T') {
    // 切换翻译状态
  }
});
```

### 2. 状态同步
可以添加跨标签页的状态同步功能：
```javascript
// 监听存储变化
window.addEventListener('storage', (e) => {
  if (e.key === 'translation-tooltip-state') {
    // 同步状态
  }
});
```

### 3. 自定义菜单
可以添加更多自定义菜单选项：
- 翻译语言选择
- 翻译样式设置
- 快捷键配置

## 故障排除

### 1. 右键菜单不显示
- 检查 `context-menu-translator.js` 是否正确加载
- 确认没有其他脚本阻止了右键事件
- 查看浏览器控制台是否有错误信息

### 2. 翻译功能不工作
- 确认已选择"开启翻译"
- 检查 `TranslationTooltip` 类是否可用
- 验证翻译字典是否正确加载

### 3. 状态不保存
- 检查浏览器是否支持本地存储
- 确认没有隐私模式限制
- 查看控制台是否有存储相关错误

## 更新日志

### v1.0.0 (2025-01-27)
- 初始版本发布
- 实现基本的右键菜单功能
- 支持翻译功能的开启/关闭
- 添加状态持久化
- 提供完整的测试页面
