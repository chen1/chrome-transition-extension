# 更新翻译功能说明

## 功能概述

新增了"更新翻译"功能，允许用户手动重新检查页面中的嵌套iframe并重新绑定翻译事件。这个功能特别适用于动态加载内容的页面，或者当iframe内容发生变化时。

## 功能特点

### 1. 智能缓存清理
- 只清理已从DOM移除的iframe缓存
- 保留仍然存在的iframe缓存，避免重复处理
- 提供备用清理方法，确保清理功能稳定
- 避免不必要的性能开销

### 2. 全面iframe检测
- 重新检测页面中所有的iframe元素
- 支持嵌套iframe的递归检测
- 自动绑定新发现的iframe事件

### 3. 事件重新绑定
- 如果翻译功能已开启，会重新绑定翻译事件
- 确保所有iframe都能正常响应翻译功能
- 保持翻译功能的一致性

### 4. 用户友好提示
- 显示更新进度通知
- 提供成功/失败状态反馈
- 详细的控制台日志记录

## 使用方法

1. **通过悬浮球菜单**：
   - 点击页面右下角的悬浮球
   - 选择"更新翻译"菜单项
   - 等待更新完成通知

2. **适用场景**：
   - 页面动态加载了新的iframe
   - iframe内容发生变化
   - 翻译功能出现异常
   - 需要重新初始化翻译系统

## 技术实现

### 核心方法

#### `updateTranslation()`
主要的更新方法，执行以下步骤：
1. 清理iframe缓存
2. 重新检测所有iframe
3. 重新绑定翻译事件（如果已开启）
4. 显示更新状态通知

#### `clearIframeCache()`
智能清理iframe缓存，只移除已从DOM中删除的iframe，保留仍然存在的iframe缓存。使用缓存管理器的 `cleanupRemovedIframes` 方法，如果该方法不可用，则使用备用的手动清理方法。

#### `refreshIframeDetection()`
调用iframeHandler的detectAndBindAllIframes方法，重新检测页面中的所有iframe。

#### `manualCleanupRemovedIframes()`
备用的手动清理方法，当缓存管理器的清理方法不可用时使用。遍历所有缓存的iframe，检查是否仍然存在于DOM中，移除已不存在的iframe缓存。

#### `rebindTranslationEvents()`
重新绑定翻译事件，先解绑现有事件，然后重新绑定。

### 错误处理

- 检查翻译工具实例是否存在
- 检查iframe处理器是否可用
- 提供详细的错误日志
- 尝试重新初始化失败的组件

## 测试方法

使用提供的测试页面 `test-update-translation.html`：

1. 打开测试页面
2. 点击悬浮球，选择"开启翻译"
3. 点击"添加iframe"按钮添加新的iframe
4. 点击悬浮球，选择"更新翻译"
5. 观察控制台日志，确认更新是否成功

## 注意事项

- 更新过程可能需要几秒钟时间
- 建议在页面内容稳定后再使用此功能
- 频繁使用可能影响性能
- 更新过程中请勿进行其他操作

## 兼容性

- 支持所有现代浏览器
- 兼容现有的翻译功能
- 不影响其他扩展功能
- 向后兼容旧版本
